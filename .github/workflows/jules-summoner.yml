name: Summon Jules on Failure

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  issues: write
  actions: read
  contents: read

jobs:
  summon-jules:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./logs
        continue-on-error: true

      - name: Prepare Log Summary
        id: log-summary
        run: |
          # Create a temporary file for the issue body
          BODY_FILE="issue_body.md"
          touch $BODY_FILE

          # Add Header
          echo "@jules The CI workflow failed. Please analyze the failure." >> $BODY_FILE
          echo "" >> $BODY_FILE
          echo "**Failed Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" >> $BODY_FILE
          echo "" >> $BODY_FILE
          echo "### Log Snippet" >> $BODY_FILE

          # Check if we actually found logs
          if [ -d "./logs" ] && [ "$(ls -A ./logs)" ]; then
            echo "\`\`\`text" >> $BODY_FILE
            
            # Loop through log files
            while IFS= read -r log_file; do
              filename=$(basename "$log_file")
              echo -e "\n\n### ðŸ“„ Log: $filename" >> $BODY_FILE
              
              if grep -iq "error" "$log_file"; then
                echo "... (Smart Grep 'error') ..." >> $BODY_FILE
                grep -C 5 -i "error" "$log_file" | tail -n 100 >> $BODY_FILE
              else
                tail -n 100 "$log_file" >> $BODY_FILE
              fi
            done < <(find ./logs -type f -name "*.log")
            
            echo "\`\`\`" >> $BODY_FILE
          else
            echo "_No log artifacts found (Pass/Fail jobs might not have uploaded logs)._" >> $BODY_FILE
          fi

      - name: Read Log Summary
        id: read-log
        run: |
          {
            echo 'BODY<<EOF'
            cat issue_body.md
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Invoke Jules
        uses: google-labs-code/jules-invoke@v1
        with:
          jules_api_key: ${{ secrets.JULES_TOKEN }}
          prompt: |
            The CI workflow failed. Please analyze the failure log below and propose a fix.

            ${{ steps.read-log.outputs.BODY }}
