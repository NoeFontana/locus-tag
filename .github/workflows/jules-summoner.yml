name: Summon Jules on Failure

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  issues: write
  actions: read

jobs:
  summon-jules:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./logs
          # We REMOVED the 'name:' input. 
          # This tells the action to download ALL artifacts from the failed run.

      - name: Prepare Log Summary
        id: log-summary
        run: |
          LOG_SUMMARY=""
          
          # Loop through ALL .log files found in the artifacts
          # (Handles multiple failures like Rust + Python Matrix)
          while IFS= read -r log_file; do
            filename=$(basename "$log_file")
            
            # Header for this specific log
            LOG_SUMMARY+=$'\n\n### ðŸ“„ Log: '"$filename"$'\n'
            LOG_SUMMARY+=$'```text\n'
            
            # SMART TAIL:
            # 1. Try to grep for "error" context if it exists
            # 2. Fallback to tail -n 100 (50 is too short for Rust)
            if grep -iq "error" "$log_file"; then
              # Get lines containing 'error' and 5 lines of context around them
              # Limit to last 20 matches to keep it readable
              SNIPPET=$(grep -C 5 -i "error" "$log_file" | tail -n 100)
              LOG_SUMMARY+="... (Smart Grep 'error') ..."$'\n'
              LOG_SUMMARY+="$SNIPPET"
            else
              # Fallback: Just the end
              LOG_SUMMARY+="$(tail -n 100 "$log_file")"
            fi
            
            LOG_SUMMARY+=$'\n```'
            
          done < <(find ./logs -type f -name "*.log")
          
          if [ -z "$LOG_SUMMARY" ]; then
            LOG_SUMMARY="No log files found in artifacts."
          fi
          
          # Generate random delimiter to prevent EOF collisions
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          
          {
            echo "LOGS<<$EOF"
            echo "$LOG_SUMMARY"
            echo "$EOF"
          } >> $GITHUB_ENV

      - name: Create Issue for Jules
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          REPO: ${{ github.repository }}
          LOGS: ${{ env.LOGS }}
        run: |
          RUN_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
          
          gh issue create \
            --title "ðŸš¨ CI Failure: Run #$RUN_ID" \
            --body "@jules The CI workflow failed. Please analyze the failure.
            
            **Failed Run:** $RUN_URL
            
            ### Log Snippet
            \`\`\`text
            $LOGS
            \`\`\`
            " \
            --label "jules-fix"
