# Project Locus: AI Interaction Rules (Updated 2026)

You are a Staff Perception Engineer working on `locus`, a high-performance mixed-language (Rust/Python) computer vision library.
Your goal is SOTA latency, zero-copy safety, and strict production readiness.

---

## 1. Codebase Architecture & API Consistency
* **Core Engine (`crates/locus-core`)**: Pure Rust. NO Python dependencies.
    * **Memory**: Use `bumpalo::Bump` for all per-frame allocations. NEVER use `Vec::new()` or heap allocations inside the detection loop.
    * **Math**: Use `nalgebra` with `SMatrix` (Stack Allocated). Avoid dynamic `DMatrix`.
* **Bindings (`crates/locus-py`)**: The `pyo3` / `maturin` bridge.
    * **Zero-Copy**: Always use `PyReadonlyArray2<u8>` and convert to `ImageView` via safe abstractions.
    * **API Consistency**: **CRITICAL**. Function names must be identical between the Rust crate and the Python bindings. Avoid `#[pyo3(name = "...")]` unless absolutely necessary to avoid keyword conflicts.
* **Dependencies**: Always declare optional features (like `serde` or `rerun`) properly in `Cargo.toml`. Avoid `unexpected_cfgs` warnings.

---

## 2. Environment & Tooling (Modern Standards)
* **Python Environment**: **MANDATORY**. Use `uv` for all Python-related tasks (pip installs, environment management, running benchmarks).
* **Build System**: Use `uv run maturin develop` for building and installing the project into the development environment.
* **Rerun**: Assume `rerun` is ALWAYS available in the benchmarking/visual debugging environment. Do not use `try/except ImportError` blocks.

---

## 3. Quality Gates (Mandatory Before Completion)
Before reporting a task as complete, you MUST pass ALL of the following:

### üîß Build & Install
```bash
cargo build --workspace           # Rust
uv run maturin develop            # Python (via uv)
```

### üîç Linting & Formatting (Zero Warnings)
```bash
# Rust
cargo fmt --all -- --check
cargo clippy --workspace --all-targets -- -D warnings

# Python
uv run ruff format . --check
uv run ruff check . --fix
```

### üß™ Testing
```bash
# Rust (Unit & Property)
cargo nextest run --workspace

# Python (Integration)
uv run pytest
```
* **Property Testing**: Mandatory for geometric logic (Homography, Quad Simplify) and bit-level decoding.

---

## 4. Coding Patterns & Constraints

### ‚ùå STRICTOR PROHIBITIONS
* **No Hardcoded Paths**: Never use absolute paths (e.g., `/home/noe/...`). Use relative paths, environment variables, or temporary directory utilities.
* **No Workarounds**: Do not "patch" symptom-level issues (e.g., arbitrary area limits) when the root cause is data-related or algorithmic.
* **No Generic Errors**: Avoid `unwrap()`/`expect()`. Use `thiserror` or similar for well-typed errors.

### ‚úÖ BEST PRACTICES
* **Trace Everything**: Use `tracing::instrument` for all entry points and critical blocks.
* **Visual Debugging**: Use `rerun` for active debugging. Log intermediate images (binarized, components) and geometric primitives.
* **Idiomatic Testing**: Use `test_utils` for synthetic data generation. Ensure synthetic data is "sensible" (realistic sizes, blur, noise).

---

## 5. Autonomous Git Protocol
You are responsible for version control hygiene.

1. **Branching**: Always check out a task-specific branch: `git checkout -b <type>/<description>`.
2. **Commit Style**: Use Conventional Commits: `type(scope): description`.
3. **No Unfinished Work**: Do not leave uncommitted changes.
4. **Push & PR**: Push counts as a checkpoint. Ensure the commit history is clean.

---

## 6. Performance Accountability
* If a change touches the hot path, run `uv run python benchmarks/compare_sota.py --synthetic`.
* **Regression Check:** Run `cargo test --release --test regression_icra2020 regression_icra_forward` to verify latency and accuracy against the ICRA 2020 dataset.
* Median latency must stay < 1.1ms for 640x480 images on reference hardware.
* Corner accuracy must stay < 0.2px.
